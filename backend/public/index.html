<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Загрузка…</title>
  <link rel="stylesheet" href="./admin.css"/>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <div class="card">Определяем роль пользователя…</div>
    <div id="diag" class="muted" style="margin-top:8px; white-space:pre-wrap"></div>
  </div>

  <script>
  (function(){
    'use strict';
    const API_BASE = location.origin;
    const diag = document.getElementById('diag');

    function log(s){ diag.textContent += (diag.textContent ? '\n' : '') + s; }

    function getInitData(){
      const tg = window.Telegram && window.Telegram.WebApp;
      // 1) Обычный путь
      if (tg && typeof tg.initData === 'string' && tg.initData) return tg.initData;
      // 2) initDataUnsafe
      if (tg && tg.initDataUnsafe && typeof tg.initDataUnsafe === 'object'){
        try{
          const p = new URLSearchParams();
          if (tg.initDataUnsafe.query_id) p.set('query_id', tg.initDataUnsafe.query_id);
          if (tg.initDataUnsafe.user) p.set('user', JSON.stringify(tg.initDataUnsafe.user));
          if (tg.initDataUnsafe.start_param) p.set('start_param', tg.initDataUnsafe.start_param);
          if (tg.initDataUnsafe.auth_date) p.set('auth_date', String(tg.initDataUnsafe.auth_date));
          if (tg.initDataUnsafe.hash) p.set('hash', tg.initDataUnsafe.hash);
          if (p.get('hash')) return p.toString();
        }catch(e){}
      }
      // 3) Иногда TG Desktop кладёт в hash
      if (location.hash && location.hash.includes('tgWebAppData=')){
        try{
          const h = new URLSearchParams(location.hash.slice(1));
          const raw = h.get('tgWebAppData');
          if (raw) return decodeURIComponent(raw);
        }catch(e){}
      }
      return '';
    }

    async function whoAmI(init){
      const url = new URL(API_BASE + '/api/me');
      if (init) url.searchParams.set('initData', encodeURIComponent(init));
      const r = await fetch(url.toString());
      const j = await r.json().catch(()=>({}));
      if (!r.ok || j?.ok === false) throw new Error(j?.error || r.statusText);
      return j.user;
    }

    async function main(){
      try { window.Telegram?.WebApp?.ready?.(); } catch {}
      const init = getInitData();
      log('SDK: ' + (!!(window.Telegram && window.Telegram.WebApp)));
      log('hash: ' + (location.hash ? 'есть' : 'пусто'));
      log('initData: ' + (init ? 'получено' : 'пусто'));

      // Сначала пробуем с initData (если есть)
      if (init){
        try{
          const u = await whoAmI(init);
          return location.replace(u?.role === 'admin' ? '/admin' : '/staff');
        }catch(e){
          log('Ошибка с initData: ' + (e?.message || e));
        }
      }

      // Если initData нет — возможно включён DEV_ALLOW_UNSAFE на сервере.
      // Пробуем без initData: сервер либо пустит, либо вернёт 401.
      try{
        const u = await whoAmI('');
        return location.replace(u?.role === 'admin' ? '/admin' : '/staff');
      }catch(e){
        log('Без initData: ' + (e?.message || e));
        log('Откройте через кнопку WebApp в вашем Telegram-боте или временно включите DEV_ALLOW_UNSAFE=true.');
      }
    }

    main().catch(e=>log('Фатальная ошибка: ' + (e?.message || e)));
  })();
  </script>
</body>
</html>
